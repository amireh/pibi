<% content_for :css do %>
  <link href="/css/reports.css" rel="stylesheet" type="text/css" />
<% end %>
<% content_for :title do %><%= @year %> Report | <%= AppName %><% end %>


<h1 class="framed"><%= @year %> activity report
  <span style="float: right;" data-amount>
    <%= @balance %>
    <%= current_account.currency %>
  </span>
</h1>

<h2 class="framed">Drilldown</h2>

<p>You can "drill down" into any month of the year to view its report by clicking its block above.</p>
<ol class="segments yearly">
  <% @segments.each_pair do |month, s| %>
    <li class="segment">
      <span><%= Time.new(@year, month).strftime("%B") %></span>
      <span data-amount><%= s[:balance].to_i %></span>
    </li>
  <% end %>
</ol>

<h2 class="framed">Insights</h2>

<section class="chart stats">
  <h3>Stats</h3>

  <ol>
    <li>
      On a monthly average throughout <%= @year %>, you have:
      <ol>
        <li>
          <span>Spent: </span>
          <b class="bigger">
            <%= @spendings.round(0).abs %>
            <%= current_account.currency %>
          </b>
          <em class="big">
          -
            <%= (@spendings / 12).to_f.round(0).abs %>
            <%= current_account.currency %>
            per month
          </em>
        </li>

        <li>
          <span>Earned: </span>
          <b class="bigger">
            <%= @earnings.round(0).abs %>
            <%= current_account.currency %>
          </b>
          <em class="big">
          -
            <%= (@earnings / 12).to_f.round(0).abs %>
            <%= current_account.currency %>
            per month
          </em>
        </li>

        <li>
          <span>Saved: </span>
          <b class="bigger">
            <%= @savings.round(0).abs %>
            <%= current_account.currency %>
          </b>
          <em class="big">
          -
            <%= (@savings / 12).to_f.round(0).abs %>
            <%= current_account.currency %>
            per month
          </em>
        </li>
      </ol>
    </li>

      <li>
        <span>Transactions were done using: </span>
        <ol id="pm_ratio">
          <li data-dyn-entity="pm_ratio">
            <span class="big" style="color: #{{color}};">{{name}} &rarr; {{ratio}}%</span>
            of the time ({{count}} times)
          </li>
        </ol>
      </li>

    <li id="tsc">You spent money most on <img class="loader" src="/images/loaders/oscilloscope.gif" /> <span></span></li>
    <li id="tec">While you earned money most from <img class="loader" src="/images/loaders/oscilloscope.gif" /> <span></span></li>

  </ol>

  <span class="small hidden hint">This section has been hidden, click the header to display it again.</span>
</section>

<section class="chart">
  <h3>Balance</h3>

  <p>This chart gives you an insight into your spending and saving patterns
  across the seasons.</p>

  <div id="chart_balance"></div>

  <p class="small hidden hint">This chart has been hidden, click the header to display it again.</p>
</section>

<section class="chart">
  <h3>Savings</h3>

  <p>This chart represents the <i>ratio</i> of money saved each month which appears in <span class="green">green</span>.
    The total amount spent
    is shown in <span class="red">red</span>.
  </p>

  <div id="chart_savings"></div>
  <p class="small hidden hint">This chart has been hidden, click the header to display it again.</p>
</section>

<section class="chart">
  <h3>Spendings by Category</h3>

  <p>This shows how much money was spent on each category.</p>

  <div id="chart_category_spendings"></div>
  <p class="small hidden hint">This chart has been hidden, click the header to display it again.</p>
</section>


<% content_for :deferred_js do %>
  <script type="text/javascript" src="/js/highcharts/js/highcharts.js"></script>
  <script type="text/javascript">
    $(function() {
      ui.account_currency = "<%= current_account.currency %>";
      var date_range = {
        begin: "<%= to_jQueryUI_date(@this_year) %>)",
        end:   "<%= to_jQueryUI_date(@next_year) %>)",
        round: true
      }
      var ajax_tgt = null;
      $(document).ajaxComplete(function() {
        if (ajax_tgt) {
          ajax_tgt.find("img.loader").hide();
        }
      })
      $.ajax({
        url: "/users/<%= current_user.id %>/stats/payment_methods/ratio.json",
        data: date_range,
        success: function(stats) {
          dynamism.inject(stats, $("#pm_ratio"));
        }
      });

      $.ajax({
        url: "/users/<%= current_user.id %>/stats/categories/top_spending.json",
        data: date_range,
        success: function(stats) {
          ajax_tgt = $("#tsc");
          $("#tsc span").html(pibi.natural_join(stats, ', ', ', and ', [ '<span class="big">', '</span>' ]));
        }
      });

      $.ajax({
        url: "/users/<%= current_user.id %>/stats/categories/top_earning.json",
        data: date_range,
        success: function(stats) {
          ajax_tgt = $("#tec");
          $("#tec span").html(pibi.natural_join(stats, ', ', ', and ', [ '<span class="big">', '</span>' ]));
        }
      });

      $.ajax({
        url: "/users/<%= current_user.id %>/stats/accounts/<%= current_account.id %>/monthly/balance.json",
        data: date_range,
        success: function(stats) {
          ui.charts.yearly.plot_balance([{ name: 'Balance', data: stats }], 'chart_balance');
        }
      });

      $.ajax({
        url: "/users/<%= current_user.id %>/stats/accounts/<%= current_account.id %>/monthly/savings.json",
        data: date_range,
        success: function(stats) {
          console.log(stats)
          ui.charts.yearly.plot_savings(stats.savings, stats.spendings, 'chart_savings');
        }
      });

      $.ajax({
        url: "/users/<%= current_user.id %>/stats/categories/yearly/spendings.json",
        data: date_range,
        success: function(stats) {
          console.log(stats)
          // ui.charts.yearly.plot_balance([{ name: 'Balance', data: stats }], 'chart_balance');
          ui.charts.yearly.
            plot_category_spendings([{ name: 'Money spent', data: stats.spendings }], stats.names, 'chart_category_spendings');
        }
      });

    });
  </script>
<% end %>